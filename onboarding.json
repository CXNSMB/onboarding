{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.1-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
    "_EXPERIMENTAL_FEATURES_ENABLED": [
      "Asserts"
    ],
    "_generator": {
      "name": "bicep",
      "version": "0.36.1.42791",
      "templateHash": "10116539140905546292"
    }
  },
  "parameters": {
    "appName": {
      "type": "string",
      "defaultValue": "CXNSMB-github-lh",
      "metadata": {
        "description": "Naam van de App Registration"
      }
    },
    "roleDefinitionId": {
      "type": "string",
      "defaultValue": "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9",
      "metadata": {
        "description": "RBAC rol om toe te wijzen aan de federated identity"
      }
    }
  },
  "imports": {
    "microsoftGraphV1": {
      "provider": "MicrosoftGraph",
      "version": "0.2.0-preview"
    }
  },
  "resources": {
    "appReg": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications@v1.0",
      "properties": {
        "displayName": "[parameters('appName')]",
        "uniqueName": "[parameters('appName')]",
        "notes": "This apps keeps teh CXNSMB lighthouse up to date",
        "api": {
          "requestedAccessTokenVersion": 2
        }
      }
    },
    "sp": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/servicePrincipals@v1.0",
      "properties": {
        "appId": "[reference('appReg').appId]"
      },
      "dependsOn": [
        "appReg"
      ]
    },
    "roleAssignment": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-04-01-preview",
      "name": "[guid(subscription().subscriptionId, parameters('appName'), parameters('roleDefinitionId'))]",
      "properties": {
        "principalId": "[reference('sp').id]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
        "description": "GitHub Actions service principal with restricted role assignment permissions",
        "condition": "(\r\n      (\r\n        !(ActionMatches{\"Microsoft.Authorization/roleAssignments/write\"})\r\n      )\r\n      OR\r\n      (\r\n        ActionMatches{\"Microsoft.Authorization/roleAssignments/write\"}\r\n        AND\r\n        NOT (\r\n          Resource[Microsoft.Authorization/roleAssignments:RoleDefinitionId] StringEquals \"8e3af657-a8ff-443c-a75c-2fe8c4bcb635\"\r\n          OR\r\n          Resource[Microsoft.Authorization/roleAssignments:RoleDefinitionId] StringEquals \"18d7d88d-d35e-4fb5-a5c3-7773c20a72d9\"\r\n          OR\r\n          Resource[Microsoft.Authorization/roleAssignments:RoleDefinitionId] StringEquals \"f58310d9-a9f6-439a-9e8d-f62e7b41a168\"\r\n        )\r\n      )\r\n    )",
        "conditionVersion": "2.0"
      },
      "dependsOn": [
        "sp"
      ]
    }
  },
  "outputs": {
    "appregid": {
      "type": "string",
      "value": "[reference('appReg').appId]"
    },
    "subscriptionId": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "tenantId": {
      "type": "string",
      "value": "[subscription().tenantId]"
    },
    "servicePrincipalId": {
      "type": "string",
      "value": "[reference('sp').id]"
    },
    "appRegistrationId": {
      "type": "string",
      "value": "[reference('appReg').appId]"
    },
    "createFederatedCredentialCommand": {
      "type": "string",
      "value": "[format('az ad app federated-credential create --id {0} --parameters \"{{\\\"name\\\": \\\"github-oidc\\\", \\\"issuer\\\": \\\"https://token.actions.githubusercontent.com\\\", \\\"subject\\\": \\\"repo:CXNSMB/onboarding:ref:refs/heads/main\\\", \\\"description\\\": \\\"GitHub Actions OIDC federated credential\\\", \\\"audiences\\\": [\\\"api://AzureADTokenExchange\\\"]}}\"', reference('appReg').appId)]"
    },
    "githubSecrets": {
      "type": "object",
      "value": {
        "AZURE_CLIENT_ID": "[reference('appReg').appId]",
        "AZURE_TENANT_ID": "[subscription().tenantId]",
        "AZURE_SUBSCRIPTION_ID": "[subscription().subscriptionId]"
      }
    },
    "securityInfo": {
      "type": "object",
      "value": {
        "message": "This service principal has User Access Administrator with security restrictions",
        "forbiddenRoles": [
          "8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
          "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9",
          "f58310d9-a9f6-439a-9e8d-f62e7b41a168"
        ],
        "allowedRoles": [
          "b24988ac-6180-42a0-ab88-20f7382dd24c",
          "acdd72a7-3385-48ef-bd42-f606fba81ae7",
          "17d1049b-9a84-46fb-8f53-869881c3d3ab"
        ]
      }
    }
  }
}