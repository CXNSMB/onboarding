{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appName": {
      "type": "string",
      "defaultValue": "CXNSMB-github-lighthouse",
      "metadata": {
        "description": "Naam van de App Registration"
      }
    },
    "roleDefinitionId": {
      "type": "string",
      "defaultValue": "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9",
      "metadata": {
        "description": "RBAC rol om toe te wijzen aan de federated identity"
      }
    }
  },
  "variables": {
    "roleAssignmentName": "[guid(subscription().subscriptionId, parameters('appName'), parameters('roleDefinitionId'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Graph/applications",
      "apiVersion": "v1.0",
      "name": "[parameters('appName')]",
      "properties": {
        "displayName": "[parameters('appName')]",
        "uniqueName": "[parameters('appName')]",
        "notes": "This apps keeps the CXNSMB lighthouse up to date",
        "api": {
          "requestedAccessTokenVersion": 2
        }
      }
    },
    {
      "type": "Microsoft.Graph/servicePrincipals",
      "apiVersion": "v1.0", 
      "name": "sp",
      "dependsOn": [
        "[parameters('appName')]"
      ],
      "properties": {
        "appId": "[reference(parameters('appName')).appId]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[variables('roleAssignmentName')]",
      "dependsOn": [
        "sp"
      ],
      "properties": {
        "principalId": "[reference('sp').id]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
        "principalType": "ServicePrincipal",
        "description": "GitHub Actions service principal with restricted role assignment permissions",
        "condition": "(!(ActionMatches{'Microsoft.Authorization/roleAssignments/write'}) OR (ActionMatches{'Microsoft.Authorization/roleAssignments/write'} AND !(Resource[Microsoft.Authorization/roleAssignments:RoleDefinitionId] StringEquals '8e3af657-a8ff-443c-a75c-2fe8c4bcb635' OR Resource[Microsoft.Authorization/roleAssignments:RoleDefinitionId] StringEquals '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9' OR Resource[Microsoft.Authorization/roleAssignments:RoleDefinitionId] StringEquals 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')))",
        "conditionVersion": "2.0"
      }
    }
  ],
  "outputs": {
    "appRegistrationId": {
      "type": "string",
      "value": "[reference(parameters('appName')).appId]"
    },
    "servicePrincipalId": {
      "type": "string", 
      "value": "[reference('sp').id]"
    },
    "subscriptionId": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "tenantId": {
      "type": "string",
      "value": "[subscription().tenantId]"
    }
  }
}
