{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.1-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
    "_EXPERIMENTAL_FEATURES_ENABLED": [
      "Asserts"
    ],
    "_generator": {
      "name": "bicep",
      "version": "0.36.1.42791",
      "templateHash": "6326557732410829418"
    }
  },
  "parameters": {
    "appName": {
      "type": "string",
      "defaultValue": "CXNSMB-github-lighthouse",
      "metadata": {
        "description": "Naam van de App Registration"
      }
    },
    "githubOrg": {
      "type": "string",
      "defaultValue": "CXNSMB",
      "metadata": {
        "description": "GitHub organization name"
      }
    },
    "githubRepo": {
      "type": "string",
      "defaultValue": "onboarding",
      "metadata": {
        "description": "GitHub repository name"
      }
    },
    "githubRef": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "GitHub branch or environment (e.g. main, develop, or environment name)"
      }
    }
  },
  "variables": {
    "roleDefinitionId": "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9"
  },
  "imports": {
    "microsoftGraphV1": {
      "provider": "MicrosoftGraph",
      "version": "0.2.0-preview"
    }
  },
  "resources": {
    "appReg": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications@v1.0",
      "properties": {
        "displayName": "[parameters('appName')]",
        "uniqueName": "[format('{0}-{1}', parameters('appName'), uniqueString(subscription().subscriptionId))]",
        "notes": "This apps keeps teh CXNSMB lighthouse up to date",
        "api": {
          "requestedAccessTokenVersion": 2
        }
      }
    },
    "sp": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/servicePrincipals@v1.0",
      "properties": {
        "appId": "[reference('appReg').appId]"
      },
      "dependsOn": [
        "appReg"
      ]
    },
    "federatedCredential": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications/federatedIdentityCredentials@v1.0",
      "properties": {
        "name": "[format('{0}/github-actions-{1}-{2}', reference('appReg').uniqueName, parameters('githubRepo'), parameters('githubRef'))]",
        "description": "[format('Federated credential for GitHub Actions OIDC from {0}/{1} on {2}', parameters('githubOrg'), parameters('githubRepo'), parameters('githubRef'))]",
        "audiences": [
          "api://AzureADTokenExchange"
        ],
        "issuer": "https://token.actions.githubusercontent.com",
        "subject": "[format('repo:{0}/{1}:ref:refs/heads/{2}', parameters('githubOrg'), parameters('githubRepo'), parameters('githubRef'))]"
      },
      "dependsOn": [
        "appReg"
      ]
    },
    "roleAssignment": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-04-01-preview",
      "name": "[guid(subscription().subscriptionId, parameters('appName'), variables('roleDefinitionId'))]",
      "properties": {
        "principalId": "[reference('sp').id]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitionId'))]",
        "description": "GitHub Actions service principal - cannot assign/delete Owner, User Access Admin and RBAC Admin roles",
        "condition": "((!(ActionMatches{'Microsoft.Authorization/roleAssignments/write'})) OR (@Request[Microsoft.Authorization/roleAssignments:RoleDefinitionId] ForAnyOfAllValues:GuidNotEquals {8e3af657-a8ff-443c-a75c-2fe8c4bcb635, 18d7d88d-d35e-4fb5-a5c3-7773c20a72d9, f58310d9-a9f6-439a-9e8d-f62e7b41a168})) AND ((!(ActionMatches{'Microsoft.Authorization/roleAssignments/delete'})) OR (@Resource[Microsoft.Authorization/roleAssignments:RoleDefinitionId] ForAnyOfAllValues:GuidNotEquals {8e3af657-a8ff-443c-a75c-2fe8c4bcb635, 18d7d88d-d35e-4fb5-a5c3-7773c20a72d9, f58310d9-a9f6-439a-9e8d-f62e7b41a168}))",
        "conditionVersion": "2.0"
      },
      "dependsOn": [
        "sp"
      ]
    }
  },
  "outputs": {
    "appregid": {
      "type": "string",
      "value": "[reference('appReg').appId]"
    }
  }
}